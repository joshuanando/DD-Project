DROP TABLE TOOLS PURGE;
DROP TABLE STOK_SPAREPART PURGE;
DROP TABLE SPAREPART;
DROP TABLE TOOLS_CATEGORY PURGE;
DROP TABLE CABANG PURGE;
DROP TABLE SPAREPART_CATEGORY PURGE;
DROP TABLE DTRANS PURGE;
DROP TABLE HTRANS PURGE;

CREATE TABLE TOOLS_CATEGORY(
	ID_KATEGORI VARCHAR2(9) PRIMARY KEY,
	-- CAT/001
	NAMA VARCHAR2(20) NOT NULL
);

CREATE TABLE TOOLS(
	ID_TOOLS VARCHAR2(9) PRIMARY KEY,
	-- AHASS/001
	NAMA VARCHAR2(20) NOT NULL,
	ID_KATEGORI VARCHAR2(9),
	STATUS NUMBER(1) NOT NULL,
	-- 0 = not available, 1 = available
	FOREIGN KEY (ID_KATEGORI) REFERENCES TOOLS_CATEGORY(ID_KATEGORI) 
);

CREATE TABLE CABANG(
	ID_CABANG VARCHAR2(9) PRIMARY KEY,
	NAMA_CABANG VARCHAR2(50) NOT NULL,
	ALAMAT VARCHAR2(50) NOT NULL
);

CREATE TABLE SPAREPART_CATEGORY(
	ID_CATEGORY VARCHAR2(9) PRIMARY KEY,
	CATEGORY_NAME VARCHAR2(20) NOT NULL
);

CREATE TABLE SPAREPART(
	ID_SPARE VARCHAR2(9) PRIMARY KEY,
	NAME VARCHAR2(20) NOT NULL,
	ID_CATEGORY VARCHAR2(20) NOT NULL,
	DESCRIPTION VARCHAR2(50),
	FOREIGN KEY (ID_CATEGORY) REFERENCES SPAREPART_CATEGORY(ID_CATEGORY)
);
-- data sparepart semua cabang
CREATE TABLE STOK_SPAREPART(
	ID VARCHAR2(3) PRIMARY KEY,
	ID_SPARE VARCHAR2(9) NOT NULL,
	ID_CABANG VARCHAR2(9) NOT NULL,
	STOK NUMBER(10) NOT NULL,
	FOREIGN KEY (ID_SPARE) REFERENCES SPAREPART(ID_SPARE),
	FOREIGN KEY (ID_CABANG) REFERENCES CABANG(ID_CABANG)
);

CREATE TABLE HTRANS (
	ID_Transaksi VARCHAR(14) PRIMARY KEY,
	Tanggal DATE,
	NAMA_PEMILIK VARCHAR2(50) NOT NULL,
	ALAMAT_PEMILIK VARCHAR2(50) NOT NULL,
	NO_KTP VARCHAR2(18) NOT NULL,
	NPWP VARCHAR2(20),
	NO_POLISI VARCHAR2(20) NOT NULL,
	DESKRIPSI_KENDARAAN VARCHAR2(50)
);


CREATE TABLE DTRANS (
	id VARCHAR2(9) PRIMARY KEY,
	ID_HTRANS VARCHAR2(14),
	ID_ITEM VARCHAR2(10),
	NAMA_ITEM VARCHAR2(50),
	HARGA_ITEM VARCHAR2(30),
	FOREIGN KEY (ID_HTRANS) REFERENCES HTRANS(ID_Transaksi)
);

CREATE OR REPLACE TRIGGER create_id_tools 
BEFORE INSERT ON TOOLS
FOR EACH ROW
DECLARE
	IDLAMA VARCHAR2(10);
	countid NUMBER(10);
BEGIN
	select MAX(ID_TOOLS) into IDLAMA from TOOLS;
	if (IDLAMA IS NULL) then 
		countid := 1;
	else 
		countid := substr(IDLAMA,-3,3)+1;
	end if;
	:NEW.ID_TOOLS := 'AHASS/' || lpad(countid,3,'0');
END;
/
SHOW ERR;
-- AHASS/001

--INSERT INTO TOOLS_CATEGORY VALUES ('CAT/001','PUMP');
--INSERT INTO TOOLS VALUES ('','PUMP MOTOR YAMAHA','CAT/001',1);
--SELECT * FROM TOOLS;

-- comment yang punya sendiri
-- field 1 = username
-- field 2 = password 
-- field 3 = tns listener name
-- CREATE PUBLIC DATABASE LINK cabdave CONNECT TO admin IDENTIFIED BY admin USING 'cabdave';